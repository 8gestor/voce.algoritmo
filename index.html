<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SCS: SINGULARITY v7.6 - RESPONSIVE OPS</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg: #000000; --panel: #0b0b0d; --border: #333; --cyan: #00f3ff;
            --purple: #bc13fe; --amber: #ffaa00; --green: #00ff66; --rec: #ff0044;
            --data: #0088ff; --font: 'Consolas', 'Monaco', monospace;
        }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background-color: var(--bg); color: #ccc; font-family: var(--font); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* OVERLAY DE START */
        #audioUnlocker { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .unlock-btn { padding: 25px 50px; border: 2px solid var(--cyan); color: var(--cyan); background: rgba(0, 243, 255, 0.1); font-size: 18px; font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 3px; box-shadow: 0 0 30px rgba(0, 243, 255, 0.2); animation: pulse 2s infinite; border-radius: 4px; }

        /* HEADER */
        header { border-bottom: 1px solid var(--border); padding: 0 15px; display: flex; justify-content: space-between; align-items: center; background: var(--panel); height: 50px; flex-shrink: 0; z-index: 100; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        
        .menu-btn { display: none; font-size: 24px; color: var(--cyan); cursor: pointer; padding-right: 15px; }
        h1 { margin: 0; font-size: 14px; letter-spacing: 2px; color: var(--cyan); text-shadow: 0 0 8px var(--cyan); white-space: nowrap; }
        
        .status-led { width: 10px; height: 10px; border-radius: 50%; background: #222; transition: 0.3s; border: 1px solid #000; }
        .status-led.on { background: var(--green); box-shadow: 0 0 8px var(--green); }
        .status-led.net { background: var(--data); box-shadow: 0 0 8px var(--data); }
        .status-led.spy { background: var(--rec); box-shadow: 0 0 15px var(--rec); animation: blink 0.5s infinite; }

        /* LAYOUT PRINCIPAL */
        main { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        /* SIDEBAR (Mobile First Logic) */
        aside { 
            width: 320px; background: var(--panel); border-right: 1px solid var(--border); 
            padding: 10px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; flex-shrink: 0; 
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); z-index: 50;
        }

        /* VIEWPORT (Canvas) */
        #viewport-container { flex: 1; display: flex; flex-direction: column; background: #000; position: relative; overflow: hidden; }
        #viewport { flex: 1; position: relative; }
        canvas { width: 100%; height: 100%; display: block; }

        /* MOBILE RESPONSIVENESS */
        @media (max-width: 800px) {
            .menu-btn { display: block; }
            aside { 
                position: absolute; top: 0; left: 0; height: 100%; width: 85%; max-width: 320px;
                transform: translateX(-100%); box-shadow: 10px 0 30px rgba(0,0,0,0.8);
            }
            aside.open { transform: translateX(0); }
            /* Overlay quando menu aberto */
            #viewport-container::after {
                content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
                background: rgba(0,0,0,0.5); opacity: 0; pointer-events: none; transition: 0.3s;
            }
            aside.open + #viewport-container::after { opacity: 1; pointer-events: all; }
        }

        /* UI ELEMENTS */
        .module { border: 1px solid #2a2a2a; padding: 12px; position: relative; margin-top: 5px; background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, rgba(0,0,0,0) 100%); border-radius: 4px; }
        .mod-label { position: absolute; top: -8px; left: 8px; background: var(--panel); padding: 0 5px; font-size: 9px; color: var(--cyan); text-transform: uppercase; border: 1px solid #333; letter-spacing: 1px; }

        .row { display: flex; gap: 8px; margin-bottom: 6px; }
        button { 
            flex: 1; background: #111; color: #888; border: 1px solid #444; padding: 12px 5px; 
            font-family: inherit; font-size: 11px; font-weight: bold; text-transform: uppercase; 
            cursor: pointer; transition: 0.2s; border-radius: 2px; 
        }
        button:hover:not(:disabled) { border-color: var(--cyan); color: var(--cyan); background: rgba(0,243,255,0.1); }
        button:active { transform: scale(0.98); }
        button.active { border-color: var(--cyan); color: #000; background: var(--cyan); box-shadow: 0 0 15px var(--cyan); }
        button.recording { border-color: var(--rec); color: var(--rec); animation: blink 1s infinite; background: rgba(255, 0, 68, 0.1); }
        button.spy-active { background: var(--rec); color: #fff; border-color: var(--rec); box-shadow: 0 0 20px var(--rec); }
        
        input[type="text"] { width: 100%; background: #050505; border: 1px solid #444; color: var(--green); font-family: inherit; font-size: 14px; padding: 10px; margin-bottom: 8px; outline: none; letter-spacing: 1px; text-align: center; border-radius: 2px; }
        input:focus { border-color: var(--green); }

        .id-display { font-size: 18px; color: var(--green); text-align: center; padding: 10px; border: 1px dashed #444; margin-bottom: 10px; cursor: pointer; background: #080808; letter-spacing: 2px; user-select: text; }
        
        /* DASHBOARD INFERIOR */
        #dashboard { height: 120px; background: #050508; display: flex; border-top: 1px solid var(--border); flex-shrink: 0; }
        .dash-panel { flex: 1; display: flex; flex-direction: column; border-right: 1px solid #222; }
        .dash-label { background: #111; color: #666; font-size: 9px; padding: 4px 10px; font-weight: bold; border-bottom: 1px solid #222; display:flex; justify-content:space-between; }
        
        #log-stream { flex: 1; overflow-y: auto; padding: 8px; font-size: 10px; color: #555; display: flex; flex-direction: column-reverse; font-family: monospace; }
        .log-entry { border-bottom: 1px solid #111; padding: 2px 0; display: grid; grid-template-columns: 50px 1fr; gap:5px; }
        
        /* HUD & ANIMATIONS */
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0, 243, 255, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(0, 243, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 243, 255, 0); } }

        .hud { position: absolute; pointer-events: none; padding: 15px; z-index: 10; top:0; left:0; }
        .val-big { font-size: 24px; font-weight: bold; color: var(--cyan); text-shadow: 0 0 10px var(--cyan); }
        .modem-hud { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); color: var(--amber); font-size: 14px; background: rgba(0,0,0,0.9); padding: 15px; border: 1px solid var(--amber); display: none; z-index: 20; text-align: center; font-weight: bold; box-shadow: 0 0 50px #000; }

        /* DIAGNOSTICS */
        .spec-row { display: flex; align-items: center; gap: 10px; font-size: 9px; margin-bottom: 4px; }
        .spec-name { width: 30px; text-align: right; color: #777; }
        .bar-container { flex: 1; height: 4px; background: #111; border: 1px solid #333; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.1s; }
        .bar-infra { background: var(--purple); } .bar-audio { background: var(--cyan); } .bar-ultra { background: #ff0055; }
        
        #ruler-pointer { position: absolute; width: 100%; height: 2px; background: #fff; left: 0; box-shadow: 0 0 10px #fff; transition: top 0.1s; z-index: 5; }
    </style>
</head>
<body>

<div id="audioUnlocker">
    <div style="color:#aaa; margin-bottom:20px; font-size:12px; font-family: monospace; letter-spacing: 1px;">SISTEMA DE ESCUTA ATIVA</div>
    <button class="unlock-btn" onclick="SCS.unlockAudio()">START SYSTEM</button>
</div>

<header>
    <div style="display:flex; align-items:center;">
        <span class="menu-btn" onclick="toggleMenu()">‚ò∞</span>
        <h1>SCS: SINGULARITY v7.6</h1>
    </div>
    <div style="display:flex; align-items:center; gap:10px;">
        <span id="headerStatus" style="font-size:10px; color:#444;">WAITING</span>
        <div id="sysLed" class="status-led"></div>
    </div>
</header>

<main>
    <aside id="sidebar">
        <div class="module">
            <span class="mod-label">01. CONTROLES</span>
            <div class="row">
                <button id="btnInit" disabled style="color:var(--green); border-color:var(--green);">ENGINE</button>
                <button onclick="location.reload()" style="color:var(--amber); border-color:var(--amber);">RESET</button>
            </div>
        </div>

        <div class="module">
            <span class="mod-label">02. OSINT LINK (P2P)</span>
            <div id="myIdDisplay" class="id-display" onclick="SCS.Net.copyId()">...</div>
            <div class="row">
                <input type="text" id="targetId" placeholder="ID DO ALVO">
            </div>
            <div class="row">
                <button id="btnConnect" onclick="SCS.Net.connect()" disabled style="color:var(--data)">üîó LINKAR</button>
            </div>
            <div class="row" style="margin-top:5px;">
                <button id="btnSpy" onclick="SCS.Net.toggleSpy()" disabled style="color:var(--rec); border:1px solid var(--rec);">ESCUTA: OFF</button>
            </div>
        </div>

        <div class="module">
            <span class="mod-label">03. DATA & FILES</span>
            <input type="text" id="chatMsg" placeholder="MENSAGEM..." onkeypress="if(event.key==='Enter') SCS.DataLink.send()">
            <div class="row">
                <button id="btnTx" onclick="SCS.DataLink.send()" disabled style="color:var(--green)">ENVIAR</button>
                <button id="btnRec" onclick="SCS.toggleRecording()" disabled>‚óè GRAVAR</button>
                <button id="btnExport" onclick="SCS.exportLog()" disabled>üíæ SALVAR</button>
            </div>
        </div>

        <div class="module">
            <span class="mod-label">04. VISUAL LAYERS</span>
            <div class="spec-row">
                <span class="spec-name">LOW</span><div class="bar-container"><div id="barInfra" class="bar-fill bar-infra"></div></div>
            </div>
            <div class="spec-row">
                <span class="spec-name">MID</span><div class="bar-container"><div id="barAudio" class="bar-fill bar-audio"></div></div>
            </div>
            <div class="spec-row">
                <span class="spec-name">HI</span><div class="bar-container"><div id="barUltra" class="bar-fill bar-ultra"></div></div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:8px;">
                <button class="active" onclick="SCS.toggleLayer('ORB', this)">ORB</button>
                <button class="active" onclick="SCS.toggleLayer('RAYS', this)">RAYS</button>
                <button class="active" onclick="SCS.toggleLayer('DRONES', this)">DRONES</button>
                <button class="active" onclick="SCS.toggleLayer('HARMONICS', this)">FRACT</button>
            </div>
        </div>
        
        <button onclick="toggleMenu()" style="margin-top:10px; border-color:#333; color:#555;">FECHAR MENU</button>
    </aside>

    <div id="viewport-container" onclick="closeMenuIfMobile()">
        <div id="viewport">
            <canvas id="scope"></canvas>
            <div class="hud">
                <div style="font-size:9px; color:var(--cyan); letter-spacing:1px; font-weight:bold;">PEAK FREQ</div>
                <div class="val-big" id="hudFreq">0.0</div>
                <div id="hudTime" style="color:#444; font-size:9px; margin-top:2px;">T+ 00:00:00</div>
            </div>
            <div id="modemHud" class="modem-hud">LINK_ACTIVE</div>
            
             <div style="position:absolute; right:0; top:0; height:100%; width:40px; border-left:1px solid #1a1a1a; display:flex; flex-direction:column; justify-content:space-between; padding:5px 0; background:rgba(0,0,0,0.5);">
                <div id="ruler-pointer"></div>
                <div style="font-size:7px; color:#444; text-align:center;">20k</div>
                <div style="font-size:7px; color:#444; text-align:center;">10k</div>
                <div style="font-size:7px; color:#444; text-align:center;">1k</div>
                <div style="font-size:7px; color:#444; text-align:center;">100</div>
                <div style="font-size:7px; color:#444; text-align:center;">0</div>
            </div>
        </div>

        <div id="dashboard">
            <div class="dash-panel">
                <div class="dash-label">
                    <span>TELEMETRY</span>
                    <span id="conn-indicator" style="color:#444;">OFFLINE</span>
                </div>
                <div id="log-stream">
                    <div style="padding:10px; text-align:center; color:#222;">SYSTEM READY...</div>
                </div>
            </div>
            <div class="dash-panel" style="border-right:none; max-width: 120px;">
                <div class="dash-label">WAVE</div>
                <div id="infra-dash"><canvas id="infraCanvas"></canvas></div>
            </div>
        </div>
    </div>
</main>

<audio id="audioEl" hidden crossorigin="anonymous"></audio>
<audio id="netAudio" autoplay playsinline style="position:absolute; opacity:0; pointer-events:none;"></audio>

<script>
// --- UI HELPERS ---
function toggleMenu() { document.getElementById('sidebar').classList.toggle('open'); }
function closeMenuIfMobile() { document.getElementById('sidebar').classList.remove('open'); }
const ID_GEN = () => Math.random().toString(36).substring(2, 6).toUpperCase();

const SCS = {
    ac: null, an: null, src: null,
    cvs: document.getElementById('scope'), ctx: document.getElementById('scope').getContext('2d'),
    infCvs: document.getElementById('infraCanvas'), infCtx: document.getElementById('infraCanvas').getContext('2d'),
    elAudio: document.getElementById('audioEl'),
    netAudio: document.getElementById('netAudio'),
    config: { fft: 2048, orbRadius: 0, fov: 650, maxMainDrones: 8 }, 
    active: false, state: 'IDLE', layers: { ORB: true, RAYS: true, DRONES: true, HARMONICS: true },
    angle: 0, peaks: [], isRecording: false, logBuffer: [], 
    sysStartTime: Date.now(), infraHistory: new Array(100).fill(0),

    unlockAudio: function() {
        document.getElementById('audioUnlocker').style.display = 'none';
        this.init();
    },

    init: async function() {
        try {
            const AC = window.AudioContext || window.webkitAudioContext;
            this.ac = new AC({ sampleRate: 48000 });
            if(this.ac.state === 'suspended') await this.ac.resume();
            
            this.an = this.ac.createAnalyser(); 
            this.an.fftSize = this.config.fft;
            this.an.smoothingTimeConstant = 0.8; // Suavizar movimento para mobile

            this.resize(); window.onresize = () => this.resize();
            this.active = true;
            
            this.enableControls();
            document.getElementById('sysLed').classList.add('on');
            document.getElementById('headerStatus').innerText = "ONLINE";
            this.sysStartTime = Date.now();
            this.loop();
            this.Net.init(); 
        } catch(e) { 
            console.error(e);
            alert("ERRO: AudioContext Bloqueado. Reinicie a p√°gina.");
            document.getElementById('audioUnlocker').style.display = 'flex';
        }
    },

    enableControls: function() {
        const ids = ['btnRec','btnExport','btnTx','btnConnect','btnSpy'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.disabled = false;
        });
    },

    resize: function() {
        const dpr = window.devicePixelRatio || 1;
        // Viewport Resize
        const rect = this.cvs.parentElement.getBoundingClientRect();
        this.cvs.width = rect.width * dpr; this.cvs.height = rect.height * dpr;
        this.ctx.scale(dpr, dpr); this.width = rect.width; this.height = rect.height;
        // Infra Resize
        const infRect = document.getElementById('infra-dash').getBoundingClientRect();
        this.infCvs.width = infRect.width; this.infCvs.height = infRect.height;
        
        this.config.orbRadius = Math.min(this.width, this.height) * 0.45;
    },

    // --- NETWORK MODULE ---
    Net: {
        peer: null, conn: null, call: null, myId: null, spyMode: false, remoteId: null, localStream: null,
        
        init: function() {
            this.myId = ID_GEN();
            document.getElementById('myIdDisplay').innerText = `ID: ${this.myId}`;
            this.peer = new Peer(this.myId, { debug: 1 });

            this.peer.on('open', (id) => {
                SCS.log("SYS", "NODE ID: " + id);
            });

            this.peer.on('error', (err) => { SCS.log("ERR", err.type); });
            this.peer.on('connection', (c) => this.handleConn(c));

            // CRITICAL: AUDIO HANDLING
            this.peer.on('call', (call) => {
                SCS.log("SURV", "SINAL DE ENTRADA...");
                call.answer(); 
                
                call.on('stream', async (remoteStream) => {
                    SCS.log("SURV", "AUDIO STREAM OK");

                    // 1. PLAYBACK (Hearing)
                    SCS.netAudio.srcObject = remoteStream;
                    SCS.netAudio.volume = 1.0;
                    try {
                        await SCS.netAudio.play();
                    } catch(e) { SCS.log("ERR", "AUTOPLAY BLOCKED"); }

                    // 2. VISUALIZATION (Seeing)
                    // Resume context explicitly to ensure analyzer works
                    if(SCS.ac.state === 'suspended') await SCS.ac.resume();
                    
                    // Create MediaStreamSource specifically for Analysis
                    // Note: We do NOT connect this to destination to avoid echo, 
                    // since netAudio is already playing to destination.
                    const remoteSrc = SCS.ac.createMediaStreamSource(remoteStream);
                    remoteSrc.connect(SCS.an);
                    
                    document.getElementById('sysLed').classList.add('net');
                    SCS.visualAlert("LINK ATIVO");
                });
            });
        },

        connect: function() {
            const target = document.getElementById('targetId').value.toUpperCase();
            if(target.length < 2) return alert("ID INVALIDO");
            const conn = this.peer.connect(target);
            this.handleConn(conn);
        },

        handleConn: function(c) {
            this.conn = c;
            this.remoteId = c.peer;
            this.conn.on('open', () => {
                SCS.log("NET", "DATA LINK OK");
                document.getElementById('conn-indicator').style.color = "#00ff66";
                document.getElementById('conn-indicator').innerText = "LINKED";
                document.getElementById('btnConnect').innerText = "OK";
                document.getElementById('btnConnect').disabled = true;
                if(!document.getElementById('targetId').value) document.getElementById('targetId').value = this.remoteId;
            });
            this.conn.on('data', (data) => {
                SCS.log("RX", data);
                SCS.visualAlert("DATA RX");
            });
            this.conn.on('close', () => {
                SCS.log("NET", "DESCONECTADO");
                document.getElementById('conn-indicator').style.color = "#444";
                document.getElementById('btnConnect').disabled = false;
                document.getElementById('btnConnect').innerText = "LINKAR";
            });
        },

        toggleSpy: async function() {
            this.spyMode = !this.spyMode;
            const btn = document.getElementById('btnSpy');
            
            if(this.spyMode) {
                btn.innerText = "TX: ON";
                btn.classList.add('spy-active');
                document.getElementById('sysLed').classList.add('spy');
                
                try {
                    if(SCS.ac.state === 'suspended') await SCS.ac.resume();
                    
                    this.localStream = await navigator.mediaDevices.getUserMedia({
                        audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
                    });

                    // Visualize Local Mic
                    const src = SCS.ac.createMediaStreamSource(this.localStream);
                    SCS.connect(src); 
                    
                    if(this.remoteId) {
                        SCS.log("SPY", "ENVIANDO -> " + this.remoteId);
                        this.call = this.peer.call(this.remoteId, this.localStream);
                    } else {
                        SCS.log("SPY", "MIC ABERTO (LOCAL)");
                    }
                    if(!SCS.isRecording) SCS.toggleRecording();
                } catch(e) { alert("ERRO MIC: " + e); this.toggleSpy(); }

            } else {
                btn.innerText = "ESCUTA: OFF";
                btn.classList.remove('spy-active');
                document.getElementById('sysLed').classList.remove('spy');
                
                if(this.localStream) {
                    this.localStream.getTracks().forEach(t => t.stop());
                    this.localStream = null;
                }
                if(this.call) { this.call.close(); this.call = null; }
            }
        },

        copyId: function() {
            navigator.clipboard.writeText(this.myId);
            SCS.log("SYS", "ID COPIADO");
        }
    },

    // --- DATA LINK ---
    DataLink: {
        send: function() {
            const input = document.getElementById('chatMsg');
            const msg = input.value;
            if(!msg) return;

            if(SCS.Net.conn && SCS.Net.conn.open) {
                SCS.Net.conn.send(msg);
                SCS.log("TX", msg);
                input.value = "";
            } else {
                alert("ERRO: Sem conex√£o P2P");
            }
        }
    },

    // --- CORE ---
    connect: function(src) {
        if(this.src) this.src.disconnect();
        this.src = src; this.src.connect(this.an);
    },
    toggleRecording: function() {
        this.isRecording = !this.isRecording;
        const btn = document.getElementById('btnRec');
        btn.classList.toggle('recording');
        if(!this.isRecording) { this.exportLog(); }
    },
    exportLog: function() {
        if(this.logBuffer.length === 0) return;
        const blob = new Blob([JSON.stringify({ frames: this.logBuffer })], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `SCS_${Date.now()}.json`; a.click();
        this.logBuffer = [];
        SCS.log("SYS", "LOG SALVO");
    },
    toggleLayer: function(l, btn) { 
        this.layers[l] = !this.layers[l]; 
        btn.classList.toggle('active'); 
    },

    // --- RENDER ---
    loop: function() {
        requestAnimationFrame(() => this.loop());
        if(!this.active) return;
        
        // Clear
        this.ctx.fillStyle = "#000000"; this.ctx.fillRect(0, 0, this.width, this.height);
        this.angle += 0.007;
        
        // Time
        const now = Date.now();
        const diff = new Date(now - this.sysStartTime);
        document.getElementById('hudTime').innerText = "T+ " + diff.toISOString().substr(11, 8);

        // Analysis
        const data = new Uint8Array(this.an.frequencyBinCount);
        this.an.getByteFrequencyData(data);
        this.analyze(data); 
        this.processInfra(data);
        this.drawGalaxy(); 
        this.drawInfraDashboard();
        this.updateRuler();

        if (this.isRecording) this.logBuffer.push({ t: now, p: this.peaks.slice(0,5) }); 
    },

    updateRuler: function() {
        if(!this.peaks[0]) return;
        const pointer = document.getElementById('ruler-pointer');
        // Logarithmic visual mapping
        const freq = this.peaks[0].f;
        const pos = Math.min(100, Math.max(0, 100 - (Math.log10(freq) / 4.3) * 100));
        pointer.style.top = pos + "%";
    },

    analyze: function(data) {
        let p = [];
        // Optimized peak finding loop
        const step = Math.floor(data.length / 100); 
        for(let i=4; i<data.length-4; i+=step) {
            if(data[i] > 100) {
                p.push({ f: i * (this.ac.sampleRate / this.config.fft), v: data[i] });
            }
        }
        this.peaks = p.sort((a,b) => b.v - a.v).slice(0, 8);
        if(this.peaks[0]) document.getElementById('hudFreq').innerText = this.peaks[0].f.toFixed(0);
        
        // Bars
        let bass = data[5] || 0;
        let mid = data[100] || 0;
        let high = data[500] || 0;
        document.getElementById('barInfra').style.width = (bass/2.55) + "%";
        document.getElementById('barAudio').style.width = (mid/2.55) + "%";
        document.getElementById('barUltra').style.width = (high/2.55) + "%";
    },

    processInfra: function(data) {
        let sum = (data[1] + data[2] + data[3]) / 3;
        this.infraHistory.push(sum); this.infraHistory.shift();
    },

    drawInfraDashboard: function() {
        const w = this.infCvs.width, h = this.infCvs.height;
        this.infCtx.fillStyle = "#050508"; this.infCtx.fillRect(0,0,w,h);
        this.infCtx.beginPath(); this.infCtx.strokeStyle = "#bc13fe"; this.infCtx.lineWidth = 2;
        for(let i=0; i<this.infraHistory.length; i++) {
            let x = (i / this.infraHistory.length) * w;
            let y = h - (this.infraHistory[i] / 255) * h;
            if(i===0) this.infCtx.moveTo(x,y); else this.infCtx.lineTo(x,y);
        }
        this.infCtx.stroke();
    },

    drawGalaxy: function() {
        const cx = this.width / 2, cy = this.height / 2;
        
        if(this.layers.ORB) {
            this.ctx.beginPath();
            const g = this.ctx.createRadialGradient(cx, cy, 0, cx, cy, this.config.orbRadius);
            g.addColorStop(0.8, "rgba(0,0,0,0)"); g.addColorStop(1, "rgba(0,243,255,0.15)");
            this.ctx.fillStyle = g; this.ctx.arc(cx, cy, this.config.orbRadius, 0, Math.PI*2); this.ctx.fill();
        }

        this.peaks.forEach((peak, i) => {
            const t = this.angle + (i * (Math.PI * 2 / this.peaks.length));
            const dist = (peak.v / 255) * this.config.orbRadius;
            const x = cx + Math.cos(t) * dist;
            const y = cy + Math.sin(t) * dist;
            
            // Drones
            if(this.layers.DRONES) {
                this.ctx.fillStyle = `hsl(${peak.f%360}, 100%, 50%)`;
                this.ctx.beginPath(); this.ctx.arc(x, y, 4, 0, Math.PI*2); this.ctx.fill();
            }
            // Rays
            if(this.layers.RAYS) {
                this.ctx.strokeStyle = "rgba(0,255,255,0.2)";
                this.ctx.beginPath(); this.ctx.moveTo(cx, cy); this.ctx.lineTo(x, y); this.ctx.stroke();
            }
        });
    },

    log: function(src, m) {
        const stream = document.getElementById('log-stream');
        const row = document.createElement('div'); row.className = 'log-entry';
        const t = new Date().toLocaleTimeString('pt-BR',{hour12:false});
        row.innerHTML = `<div style="color:#444">${t}</div><div class="log-msg"><span style="color:var(--cyan)">${src}</span> ${m}</div>`;
        stream.prepend(row);
        if(stream.childElementCount > 30) stream.removeChild(stream.lastChild);
    },
    visualAlert: function(msg) {
        const hud = document.getElementById('modemHud');
        hud.innerText = msg; hud.style.display = 'block';
        setTimeout(() => hud.style.display = 'none', 2000);
    }
};
</script>
</body>
</html>

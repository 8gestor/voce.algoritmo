<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S. v6 - RESEARCH MODULE</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';</script>

    <style>
        :root { --bg: #000000; --cyan: #00f3ff; --glass: rgba(0, 243, 255, 0.05); --font: 'Segoe UI', 'Consolas', sans-serif; }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: var(--cyan); font-family: var(--font); height: 100vh; display: flex; flex-direction: column; overflow: hidden; text-shadow: 0 0 5px var(--cyan); }
        
        #main-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; z-index: 1; }
        
        /* REACTOR */
        #reactor-container { width: 250px; height: 250px; position: relative; display: flex; justify-content: center; align-items: center; margin-bottom: 20px; transition: 0.5s; }
        canvas { position: absolute; top:0; left:0; }
        .circle-glow { position: absolute; width: 100%; height: 100%; border-radius: 50%; box-shadow: 0 0 50px rgba(0, 243, 255, 0.2), inset 0 0 20px rgba(0, 243, 255, 0.2); animation: pulse 4s infinite; }

        /* CHAT */
        #chat-panel { width: 90%; max-width: 700px; height: 250px; background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,20,30,0.9) 100%); border: 1px solid #333; border-left: 2px solid var(--cyan); padding: 15px; overflow-y: auto; margin-bottom: 20px; font-size: 14px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 8px 12px; border-radius: 4px; animation: fadeIn 0.3s; max-width: 90%; line-height: 1.4; }
        .msg.user { text-align: right; color: #fff; border-right: 2px solid #555; align-self: flex-end; }
        .msg.ai { text-align: left; color: var(--cyan); border-left: 2px solid var(--cyan); align-self: flex-start; background: var(--glass); }
        .msg.sys { font-size: 11px; color: #aaa; align-self: center; border: 1px dashed #333; }
        
        /* INPUTS */
        #input-dock { width: 90%; max-width: 700px; display: flex; gap: 10px; background: #050505; padding: 10px; border: 1px solid #222; border-radius: 30px; box-shadow: 0 0 20px rgba(0,0,0,0.8); margin-bottom: 20px; position:relative; z-index: 10; }
        input[type="text"] { flex: 1; background: transparent; border: none; color: #fff; font-family: inherit; padding: 0 15px; outline: none; font-size: 16px; }
        button { background: transparent; border: 1px solid var(--cyan); color: var(--cyan); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; font-size:14px; }
        button:hover { background: var(--glass); box-shadow: 0 0 15px var(--cyan); }
        button.active { background: var(--cyan); color: #000; box-shadow: 0 0 25px var(--cyan); }
        
        /* PAINEL DE INGESTÃƒO DE DADOS (NOVO) */
        #ingest-panel {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; max-width: 500px; background: #0a0a0c; border: 1px solid var(--cyan);
            padding: 20px; z-index: 100; display: none; box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        #ingest-panel h3 { margin-top:0; color: var(--cyan); border-bottom: 1px solid #333; padding-bottom: 10px; }
        .ingest-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .ingest-input { flex: 1; background: #000; border: 1px solid #444; color: #fff; padding: 8px; font-family: monospace; }
        .btn-rect { border-radius: 4px; width: auto; padding: 0 15px; font-size: 11px; font-weight: bold; }
        .close-btn { position: absolute; top: 10px; right: 10px; border: none; font-size: 18px; color: #555; }
        
        /* OVERLAY */
        #overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 90; display:none; }

        .hud-corner { position: absolute; padding: 20px; font-size: 10px; color: #555; pointer-events: none; }
        .top-left { top: 0; left: 0; text-align: left; border-top: 1px solid #333; border-left: 1px solid #333; width: 120px; height: 100px; }
        .top-right { top: 0; right: 0; text-align: right; border-top: 1px solid #333; border-right: 1px solid #333; width: 120px; height: 100px; }
        
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="overlay"></div>

    <div id="ingest-panel">
        <button class="close-btn" onclick="UI.toggleIngest()">Ã—</button>
        <h3>MÃ“DULO DE APRENDIZADO</h3>
        
        <p style="font-size:12px; color:#aaa;">1. APRENDER VIA URL (WEB)</p>
        <div class="ingest-row">
            <input type="text" id="urlInput" class="ingest-input" placeholder="https://exemplo.com/artigo">
            <button class="btn-rect" onclick="Jarvis.ingestURL()">LER URL</button>
        </div>

        <p style="font-size:12px; color:#aaa;">2. APRENDER VIA PDF (UPLOAD)</p>
        <div class="ingest-row">
            <input type="file" id="pdfInput" class="ingest-input" accept="application/pdf">
            <button class="btn-rect" onclick="Jarvis.ingestPDF()">LER PDF</button>
        </div>
        
        <div style="text-align:center; margin-top:20px; border-top:1px solid #222; padding-top:10px;">
            <button class="btn-rect" onclick="Jarvis.downloadMemory()" style="border-color:#00ff66; color:#00ff66;">BAIXAR MEMÃ“RIA (JSON)</button>
        </div>
    </div>

    <div class="hud-corner top-left">
        SYSTEM: ONLINE<br>
        Q&A NODES: <span id="qaCount">0</span><br>
        DOCS LIDOS: <span id="docCount" style="color:var(--cyan)">0</span>
    </div>
    
    <div id="main-container">
        <div id="reactor-container">
            <div class="circle-glow"></div>
            <canvas id="arcCanvas" width="300" height="300"></canvas>
        </div>
        <div id="chat-panel">
            <div class="msg ai"><span class="sender">J.A.R.V.I.S.</span>MÃ³dulo de pesquisa ativo. Posso ler URLs e arquivos PDF agora.</div>
        </div>
        <div id="input-dock">
            <button id="btnIngest" title="Adicionar Dados" style="font-size:18px;">+</button>
            <input type="text" id="txtInput" placeholder="FaÃ§a uma pergunta sobre os dados..." autocomplete="off">
            <button id="btnSend" title="Enviar">âž¤</button>
            <button id="btnMic" title="Voz">ðŸŽ¤</button>
        </div>
    </div>

<script>
// --- MEMÃ“RIA ---
// QA_MEMORY: Perguntas e respostas curtas (do database.json)
// DOC_MEMORY: Textos longos de PDFs e URLs
let QA_MEMORY = [];
let DOC_MEMORY = [];

const Jarvis = {
    listening: false,
    synth: window.speechSynthesis,
    recognition: null,

    // 1. INICIALIZAÃ‡ÃƒO
    init: async () => {
        // Tenta carregar QA inicial
        try {
            const res = await fetch('database.json');
            if(res.ok) QA_MEMORY = await res.json();
            UI.updateHUD();
        } catch(e) { console.log("Sem database.json, iniciando vazio."); }

        // Configura Voz
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(Speech) {
            Jarvis.recognition = new Speech();
            Jarvis.recognition.lang = 'pt-BR';
            Jarvis.recognition.continuous = false;
            Jarvis.recognition.onresult = (e) => Jarvis.processInput(e.results[0][0].transcript);
            Jarvis.recognition.onend = () => Jarvis.toggleMic(false);
        }

        // Listeners
        document.getElementById('btnMic').onclick = () => Jarvis.toggleMic();
        document.getElementById('btnSend').onclick = () => Jarvis.handleText();
        document.getElementById('btnIngest').onclick = () => UI.toggleIngest();
        document.getElementById('txtInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') Jarvis.handleText(); });
        
        Graphics.start();
    },

    // 2. LÃ“GICA DE INGESTÃƒO (APRENDIZADO)
    
    // Ler URL (Usando Proxy para evitar bloqueio CORS)
    ingestURL: async () => {
        const url = document.getElementById('urlInput').value;
        if(!url) return;
        
        UI.addMsg('sys', `Acessando a rede: ${url}...`);
        UI.toggleIngest(); // Fecha painel

        try {
            // Usa o allorigins como proxy
            const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
            const response = await fetch(proxy);
            const data = await response.json();
            
            if(!data.contents) throw new Error("Sem conteÃºdo");

            // Parser simples de HTML para Texto
            const parser = new DOMParser();
            const doc = parser.parseFromString(data.contents, 'text/html');
            
            // Pega apenas parÃ¡grafos para evitar menus/ads
            const paragraphs = Array.from(doc.querySelectorAll('p')).map(p => p.innerText).join('\n');
            
            if(paragraphs.length < 50) throw new Error("ConteÃºdo insuficiente ou bloqueado.");

            DOC_MEMORY.push({ source: "WEB: " + doc.title, content: paragraphs });
            
            UI.addMsg('ai', `URL processada. TÃ­tulo: "${doc.title}". Li ${paragraphs.length} caracteres.`);
            UI.updateHUD();

        } catch(err) {
            UI.addMsg('sys', "Erro ao ler URL. O site pode ter proteÃ§Ã£o contra bots.");
            console.error(err);
        }
    },

    // Ler PDF (Usando PDF.js)
    ingestPDF: async () => {
        const file = document.getElementById('pdfInput').files[0];
        if(!file) return;

        UI.addMsg('sys', "Processando estrutura do PDF...");
        UI.toggleIngest();

        const fileReader = new FileReader();
        fileReader.onload = async function() {
            const typedarray = new Uint8Array(this.result);
            
            try {
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                let fullText = "";

                // LÃª pÃ¡gina por pÃ¡gina
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + "\n";
                }

                DOC_MEMORY.push({ source: "PDF: " + file.name, content: fullText });
                UI.addMsg('ai', `PDF assimilado. Arquivo "${file.name}" contÃ©m ${pdf.numPages} pÃ¡ginas.`);
                UI.updateHUD();

            } catch(err) {
                UI.addMsg('sys', "Erro crÃ­tico ao ler PDF. Verifique se o arquivo nÃ£o estÃ¡ corrompido.");
            }
        };
        fileReader.readAsArrayBuffer(file);
    },

    // 3. PROCESSAMENTO INTELIGENTE
    processInput: (text) => {
        UI.addMsg('user', text);
        let response = null;
        const lower = text.toLowerCase();
        let sourceRef = "";

        // A) Verifica Comandos BÃ¡sicos
        if(lower.includes("obrigado")) response = "Ã€s ordens.";
        
        // B) Verifica QA_MEMORY (Perguntas Exatas/Triggers)
        if(!response) {
            const hit = QA_MEMORY.find(entry => entry.triggers.some(t => lower.includes(t.toLowerCase())));
            if(hit) response = hit.response;
        }

        // C) Verifica DOC_MEMORY (Pesquisa de Palavras-Chave/RAG Simplificado)
        if(!response && DOC_MEMORY.length > 0) {
            // Separa palavras-chave da pergunta (ignora "o", "que", "Ã©"...)
            const keywords = lower.split(' ').filter(w => w.length > 3);
            
            let bestMatch = { score: 0, text: "" };

            DOC_MEMORY.forEach(doc => {
                // PontuaÃ§Ã£o simples: conta quantas palavras-chave aparecem no doc
                let score = 0;
                keywords.forEach(k => {
                    const regex = new RegExp(k, "gi");
                    const count = (doc.content.match(regex) || []).length;
                    score += count;
                });

                if(score > bestMatch.score) {
                    // Tenta extrair um trecho relevante (contexto)
                    const firstKeyIndex = doc.content.toLowerCase().indexOf(keywords[0]);
                    const start = Math.max(0, firstKeyIndex - 50);
                    const excerpt = doc.content.substring(start, start + 400); // Pega 400 caracteres
                    
                    bestMatch = { score, text: excerpt + "...", source: doc.source };
                }
            });

            if(bestMatch.score > 0) {
                response = `Encontrei nos dados (${bestMatch.source}): "...${bestMatch.text}"`;
            }
        }

        // D) Fallback
        if(!response) response = "NÃ£o encontrei essa informaÃ§Ã£o nos meus dados locais ou documentos carregados.";

        setTimeout(() => Jarvis.respond(response), 500);
    },

    respond: (text) => {
        UI.addMsg('ai', text);
        if(Jarvis.synth.speaking) Jarvis.synth.cancel();
        const utter = new SpeechSynthesisUtterance(text);
        const voices = Jarvis.synth.getVoices();
        const pt = voices.find(v => v.lang.includes('pt-BR'));
        if(pt) utter.voice = pt;
        utter.rate = 1.2; 
        utter.onstart = () => Graphics.isSpeaking = true;
        utter.onend = () => Graphics.isSpeaking = false;
        Jarvis.synth.speak(utter);
    },

    toggleMic: (force) => {
        if(!Jarvis.recognition) return;
        Jarvis.listening = force !== undefined ? force : !Jarvis.listening;
        const btn = document.getElementById('btnMic');
        if(Jarvis.listening) { Jarvis.recognition.start(); btn.classList.add('active'); Graphics.speed = 0.2; }
        else { try{Jarvis.recognition.stop();}catch(e){} btn.classList.remove('active'); Graphics.speed = 0.02; }
    },
    
    handleText: () => {
        const i = document.getElementById('txtInput');
        if(i.value.trim()) { Jarvis.processInput(i.value.trim()); i.value=""; }
    },

    downloadMemory: () => {
        const fullData = [...QA_MEMORY]; // ComeÃ§a com o que jÃ¡ tinha
        // Adiciona documentos como itens de memÃ³ria, mas de forma simplificada para salvar
        // Nota: Salvar PDFs inteiros no JSON pode deixar o arquivo gigante. 
        // Aqui estamos salvando para permitir recarregar depois.
        const blob = new Blob([JSON.stringify({qa: QA_MEMORY, docs: DOC_MEMORY}, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `JARVIS_MEMORY_${Date.now()}.json`;
        a.click();
    }
};

const UI = {
    addMsg: (type, text) => {
        const p = document.getElementById('chat-panel');
        const d = document.createElement('div'); d.className = `msg ${type}`;
        if(type==='ai' || type==='user') d.innerHTML = `<span class="sender">${type.toUpperCase()}</span>${text}`;
        else d.innerText = text; // Sys msg
        p.appendChild(d); p.scrollTop = p.scrollHeight;
    },
    toggleIngest: () => {
        const el = document.getElementById('ingest-panel');
        const ov = document.getElementById('overlay');
        const show = el.style.display === 'block';
        el.style.display = show ? 'none' : 'block';
        ov.style.display = show ? 'none' : 'block';
    },
    updateHUD: () => {
        document.getElementById('qaCount').innerText = QA_MEMORY.length;
        document.getElementById('docCount').innerText = DOC_MEMORY.length;
    }
};

const Graphics = {
    cvs: document.getElementById('arcCanvas'), ctx: document.getElementById('arcCanvas').getContext('2d'),
    angle: 0, speed: 0.02, isSpeaking: false,
    start: () => Graphics.loop(),
    loop: () => {
        const ctx = Graphics.ctx; const w=300, h=300, cx=w/2, cy=h/2;
        ctx.clearRect(0,0,w,h); Graphics.angle+=Graphics.speed;
        
        ctx.strokeStyle = "#00f3ff"; ctx.lineWidth=5; ctx.beginPath();
        ctx.arc(cx, cy, 80, Graphics.angle, Graphics.angle+2); ctx.stroke();
        ctx.beginPath(); ctx.arc(cx, cy, 80, Graphics.angle+Math.PI, Graphics.angle+Math.PI+2); ctx.stroke();
        
        ctx.strokeStyle = "rgba(0, 243, 255, 0.4)"; ctx.lineWidth=2; ctx.beginPath();
        ctx.arc(cx, cy, 60, -Graphics.angle*1.5, -Graphics.angle*1.5+4); ctx.stroke();
        
        const core = Graphics.isSpeaking ? 30+Math.random()*10 : 30;
        ctx.fillStyle = "#00f3ff"; ctx.beginPath(); ctx.arc(cx, cy, 5, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle="#fff"; ctx.beginPath(); ctx.arc(cx,cy, core, 0, Math.PI*2); ctx.stroke();
        requestAnimationFrame(Graphics.loop);
    }
};

window.onload = Jarvis.init;
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S. v7 - CONVERSATIONAL CORE</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';</script>

    <style>
        :root { --bg: #000000; --cyan: #00f3ff; --glass: rgba(0, 243, 255, 0.05); --font: 'Segoe UI', 'Consolas', sans-serif; }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: var(--cyan); font-family: var(--font); height: 100vh; display: flex; flex-direction: column; overflow: hidden; text-shadow: 0 0 5px var(--cyan); }
        
        #main-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; z-index: 1; }
        
        /* REACTOR */
        #reactor-container { width: 250px; height: 250px; position: relative; display: flex; justify-content: center; align-items: center; margin-bottom: 20px; transition: 0.5s; }
        canvas { position: absolute; top:0; left:0; }
        .circle-glow { position: absolute; width: 100%; height: 100%; border-radius: 50%; box-shadow: 0 0 50px rgba(0, 243, 255, 0.2), inset 0 0 20px rgba(0, 243, 255, 0.2); animation: pulse 4s infinite; }

        /* CHAT */
        #chat-panel { width: 90%; max-width: 700px; height: 300px; background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,20,30,0.9) 100%); border: 1px solid #333; border-left: 2px solid var(--cyan); padding: 15px; overflow-y: auto; margin-bottom: 20px; font-size: 14px; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }
        .msg { padding: 8px 12px; border-radius: 4px; animation: fadeIn 0.3s; max-width: 90%; line-height: 1.4; word-wrap: break-word; }
        .msg.user { text-align: right; color: #fff; border-right: 2px solid #555; align-self: flex-end; background: rgba(255,255,255,0.05); }
        .msg.ai { text-align: left; color: var(--cyan); border-left: 2px solid var(--cyan); align-self: flex-start; background: var(--glass); }
        .msg.sys { font-size: 11px; color: #aaa; align-self: center; border: 1px dashed #333; }
        
        /* INPUTS */
        #input-dock { width: 90%; max-width: 700px; display: flex; gap: 10px; background: #050505; padding: 10px; border: 1px solid #222; border-radius: 30px; box-shadow: 0 0 20px rgba(0,0,0,0.8); margin-bottom: 20px; position:relative; z-index: 10; }
        input[type="text"] { flex: 1; background: transparent; border: none; color: #fff; font-family: inherit; padding: 0 15px; outline: none; font-size: 16px; }
        button { background: transparent; border: 1px solid var(--cyan); color: var(--cyan); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; font-size:14px; }
        button:hover { background: var(--glass); box-shadow: 0 0 15px var(--cyan); }
        button.active { background: var(--cyan); color: #000; box-shadow: 0 0 25px var(--cyan); }
        
        /* PAINEL DE INGEST√ÉO */
        #ingest-panel {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; max-width: 500px; background: #0a0a0c; border: 1px solid var(--cyan);
            padding: 20px; z-index: 100; display: none; box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        #ingest-panel h3 { margin-top:0; color: var(--cyan); border-bottom: 1px solid #333; padding-bottom: 10px; }
        .ingest-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .ingest-input { flex: 1; background: #000; border: 1px solid #444; color: #fff; padding: 8px; font-family: monospace; }
        .btn-rect { border-radius: 4px; width: auto; padding: 0 15px; font-size: 11px; font-weight: bold; }
        .close-btn { position: absolute; top: 10px; right: 10px; border: none; font-size: 18px; color: #555; }
        
        /* OVERLAY E HUD */
        #overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 90; display:none; }
        .hud-corner { position: absolute; padding: 20px; font-size: 10px; color: #555; pointer-events: none; }
        .top-left { top: 0; left: 0; text-align: left; border-top: 1px solid #333; border-left: 1px solid #333; width: 140px; height: 100px; }
        
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="overlay"></div>

    <div id="ingest-panel">
        <button class="close-btn" onclick="UI.toggleIngest()">√ó</button>
        <h3>M√ìDULO DE APRENDIZADO</h3>
        
        <p style="font-size:12px; color:#aaa;">1. APRENDER VIA URL (WEB)</p>
        <div class="ingest-row">
            <input type="text" id="urlInput" class="ingest-input" placeholder="https://exemplo.com/artigo">
            <button class="btn-rect" onclick="Jarvis.ingestURL()">LER URL</button>
        </div>

        <p style="font-size:12px; color:#aaa;">2. APRENDER VIA PDF (UPLOAD)</p>
        <div class="ingest-row">
            <input type="file" id="pdfInput" class="ingest-input" accept="application/pdf">
            <button class="btn-rect" onclick="Jarvis.ingestPDF()">LER PDF</button>
        </div>
        
        <div style="text-align:center; margin-top:20px; border-top:1px solid #222; padding-top:10px;">
            <button class="btn-rect" onclick="Jarvis.downloadMemory()" style="border-color:#00ff66; color:#00ff66;">BAIXAR MEM√ìRIA (JSON)</button>
        </div>
    </div>

    <div class="hud-corner top-left">
        SYSTEM: ONLINE<br>
        INTELLECT: <span id="qaCount" style="color:#fff">NATIVO</span><br>
        DOCS LIDOS: <span id="docCount" style="color:var(--cyan)">0</span>
    </div>
    
    <div id="main-container">
        <div id="reactor-container">
            <div class="circle-glow"></div>
            <canvas id="arcCanvas" width="300" height="300"></canvas>
        </div>
        <div id="chat-panel">
            <div class="msg ai"><span class="sender">J.A.R.V.I.S.</span>Sistemas online. O m√≥dulo de conversa√ß√£o nativo est√° ativo. Como posso ajudar?</div>
        </div>
        <div id="input-dock">
            <button id="btnIngest" title="Adicionar Dados" style="font-size:18px;">+</button>
            <input type="text" id="txtInput" placeholder="Digite ou fale algo..." autocomplete="off">
            <button id="btnSend" title="Enviar">‚û§</button>
            <button id="btnMic" title="Voz">üé§</button>
        </div>
    </div>

<script>
// --- MEM√ìRIA ---
let QA_MEMORY = []; 
let DOC_MEMORY = [];

// --- M√ìDULO DE CONVERSA√á√ÉO NATIVA (BASE DE DADOS INTERNA) ---
// Isso permite que ele converse mesmo sem ler arquivos externos
const CONVERSATION_MODULE = [
    { 
        triggers: [/oi|ol√°|ola|hey|eai|hello/i], 
        responses: ["Ol√°, senhor.", "√Äs suas ordens.", "Sistemas online. Como posso ajudar?", "Ol√°. Em que posso ser √∫til hoje?"] 
    },
    { 
        triggers: [/como (voc√™ )?est√°|tudo (bem|bom)|status/i], 
        responses: ["Todos os sistemas operando na capacidade m√°xima.", "Estou funcionando perfeitamente.", "Processadores est√°veis e prontos para pesquisa."] 
    },
    { 
        triggers: [/quem √© (voc√™|vc)|o que (√©|e) (voc√™|vc)/i], 
        responses: ["Sou J.A.R.V.I.S., uma interface de pesquisa e assist√™ncia virtual.", "Sou um sistema inteligente rodando em JavaScript puro."] 
    },
    { 
        triggers: [/obrigado|vlw|valeu|grato/i], 
        responses: ["Disponha.", "√â um prazer servir.", "Sempre √† disposi√ß√£o."] 
    },
    { 
        triggers: [/criador|quem te (criou|fez)/i], 
        responses: ["Fui desenvolvido como um experimento de c√≥digo aberto.", "Minha arquitetura foi desenhada para ser leve e rodar no navegador."] 
    },
    { 
        triggers: [/pode fazer|funcionalidades|ajuda/i], 
        responses: ["Posso ler artigos da Web, processar arquivos PDF e responder perguntas sobre eles. Ou podemos apenas conversar."] 
    },
    {
        triggers: [/tchau|sair|desligar/i],
        responses: ["Entendido. Entrando em modo de espera.", "At√© logo, senhor.", "Hibernando sistemas."]
    }
];

const Jarvis = {
    listening: false,
    synth: window.speechSynthesis,
    recognition: null,

    // 1. INICIALIZA√á√ÉO
    init: async () => {
        // Tenta carregar QA opcional, mas n√£o falha se n√£o existir
        try {
            const res = await fetch('database.json');
            if(res.ok) QA_MEMORY = await res.json();
        } catch(e) { console.log("Modo offline: Usando apenas regras internas."); }

        UI.updateHUD();

        // Configura Voz (Reconhecimento)
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(Speech) {
            Jarvis.recognition = new Speech();
            Jarvis.recognition.lang = 'pt-BR';
            Jarvis.recognition.continuous = false;
            Jarvis.recognition.interimResults = false;
            Jarvis.recognition.onresult = (e) => Jarvis.processInput(e.results[0][0].transcript);
            Jarvis.recognition.onend = () => Jarvis.toggleMic(false);
        }

        // Listeners
        document.getElementById('btnMic').onclick = () => Jarvis.toggleMic();
        document.getElementById('btnSend').onclick = () => Jarvis.handleText();
        document.getElementById('btnIngest').onclick = () => UI.toggleIngest();
        document.getElementById('txtInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') Jarvis.handleText(); });
        
        Graphics.start();
    },

    // 2. INGEST√ÉO DE DADOS (APRENDIZADO)
    ingestURL: async () => {
        const url = document.getElementById('urlInput').value;
        if(!url) return;
        UI.addMsg('sys', `Acessando rede neural: ${url}...`);
        UI.toggleIngest(); 

        try {
            // Proxy para evitar CORS
            const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
            const response = await fetch(proxy);
            const data = await response.json();
            if(!data.contents) throw new Error("Sem conte√∫do");

            const parser = new DOMParser();
            const doc = parser.parseFromString(data.contents, 'text/html');
            // Remove scripts e estilos para limpar o texto
            doc.querySelectorAll('script, style, nav, footer').forEach(el => el.remove());
            const text = doc.body.innerText.replace(/\s+/g, ' ').trim();
            
            if(text.length < 50) throw new Error("Conte√∫do insuficiente.");

            DOC_MEMORY.push({ source: "WEB: " + doc.title, content: text });
            UI.addMsg('ai', `Dados processados. T√≠tulo: "${doc.title}".`);
            UI.updateHUD();
        } catch(err) {
            UI.addMsg('sys', "Falha ao acessar a URL. O site pode estar protegido.");
        }
    },

    ingestPDF: async () => {
        const file = document.getElementById('pdfInput').files[0];
        if(!file) return;
        UI.addMsg('sys', "Desconstruindo bin√°rios do PDF...");
        UI.toggleIngest();

        const fileReader = new FileReader();
        fileReader.onload = async function() {
            try {
                const typedarray = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                let fullText = "";

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(item => item.str).join(' ') + " ";
                }

                DOC_MEMORY.push({ source: "PDF: " + file.name, content: fullText });
                UI.addMsg('ai', `Documento "${file.name}" assimilado. Mem√≥ria expandida.`);
                UI.updateHUD();
            } catch(err) {
                UI.addMsg('sys', "Erro cr√≠tico ao ler arquivo PDF.");
            }
        };
        fileReader.readAsArrayBuffer(file);
    },

    // 3. C√âREBRO (PROCESSAMENTO)
    processInput: (text) => {
        UI.addMsg('user', text);
        
        // Normaliza√ß√£o (remove acentos e p√µe min√∫sculo)
        const cleanText = text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        let response = null;

        // A) PRIORIDADE 1: Verifica Database JSON (se existir)
        if(!response && QA_MEMORY.length > 0) {
            const hit = QA_MEMORY.find(entry => entry.triggers.some(t => cleanText.includes(t.toLowerCase())));
            if(hit) response = hit.response;
        }

        // B) PRIORIDADE 2: Pesquisa nos Documentos (RAG Simples)
        if(!response && DOC_MEMORY.length > 0) {
            // Pega palavras chaves (> 3 letras)
            const keywords = cleanText.split(' ').filter(w => w.length > 3 && !['como','quem','onde','para','porque'].includes(w));
            
            let bestMatch = { score: 0, text: "", source: "" };

            DOC_MEMORY.forEach(doc => {
                let score = 0;
                keywords.forEach(k => {
                    const regex = new RegExp(k, "gi");
                    const matches = doc.content.match(regex);
                    if(matches) score += matches.length;
                });

                // Se tiver pelo menos 1 match relevante
                if(score > bestMatch.score && score >= 1) { 
                    const idx = doc.content.toLowerCase().indexOf(keywords[0]);
                    const start = Math.max(0, idx - 60);
                    const end = Math.min(doc.content.length, idx + 350);
                    // Limpa quebras de linha
                    const snippet = doc.content.substring(start, end).replace(/\n/g, " ");
                    bestMatch = { score, text: snippet, source: doc.source };
                }
            });

            if(bestMatch.score > 0) {
                response = `Encontrei isto em ${bestMatch.source}: "...${bestMatch.text}..."`;
            }
        }

        // C) PRIORIDADE 3: Conversa Nativa (Small Talk)
        if(!response) {
            for (let rule of CONVERSATION_MODULE) {
                const match = rule.triggers.some(regex => regex.test(text)); 
                if(match) {
                    response = rule.responses[Math.floor(Math.random() * rule.responses.length)];
                    break;
                }
            }
        }

        // D) FALLBACK (Se n√£o entendeu nada)
        if(!response) {
            const fallbacks = [
                "Meus protocolos n√£o reconhecem esse comando.",
                "Poderia reformular? Meus dados sobre isso s√£o limitados.",
                "N√£o encontrei essa informa√ß√£o nos documentos carregados.",
                "Processamento incompleto. Tente ser mais espec√≠fico."
            ];
            response = fallbacks[Math.floor(Math.random() * fallbacks.length)];
        }

        setTimeout(() => Jarvis.respond(response), 600);
    },

    // 4. S√çNTESE DE VOZ (FALA)
    respond: (text) => {
        UI.addMsg('ai', text);
        
        if(Jarvis.synth.speaking) Jarvis.synth.cancel();
        
        const utter = new SpeechSynthesisUtterance(text);
        const voices = Jarvis.synth.getVoices();
        
        // Tenta pegar uma voz PT-BR masculina ou Google
        const pt = voices.find(v => v.lang.includes('pt-BR'));
        if(pt) utter.voice = pt;
        
        utter.pitch = 0.9; // Um pouco mais grave
        utter.rate = 1.1;  // Um pouco mais r√°pido
        
        utter.onstart = () => Graphics.isSpeaking = true;
        utter.onend = () => Graphics.isSpeaking = false;
        
        Jarvis.synth.speak(utter);
    },

    toggleMic: (force) => {
        if(!Jarvis.recognition) { alert("Navegador sem suporte a voz."); return; }
        Jarvis.listening = force !== undefined ? force : !Jarvis.listening;
        const btn = document.getElementById('btnMic');
        
        if(Jarvis.listening) { 
            try { Jarvis.recognition.start(); } catch(e){}
            btn.classList.add('active'); 
            Graphics.speed = 0.2; 
        } else { 
            try{Jarvis.recognition.stop();}catch(e){} 
            btn.classList.remove('active'); 
            Graphics.speed = 0.02; 
        }
    },
    
    handleText: () => {
        const i = document.getElementById('txtInput');
        if(i.value.trim()) { Jarvis.processInput(i.value.trim()); i.value=""; }
    },

    downloadMemory: () => {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({qa: QA_MEMORY, docs: DOC_MEMORY}, null, 2));
        const a = document.createElement('a');
        a.href = dataStr;
        a.download = `JARVIS_MEMORY_${Date.now()}.json`;
        a.click();
    }
};

const UI = {
    addMsg: (type, text) => {
        const p = document.getElementById('chat-panel');
        const d = document.createElement('div'); d.className = `msg ${type}`;
        if(type==='ai' || type==='user') d.innerHTML = `<span class="sender">${type.toUpperCase()}</span>${text}`;
        else d.innerText = text; 
        p.appendChild(d); p.scrollTop = p.scrollHeight;
    },
    toggleIngest: () => {
        const el = document.getElementById('ingest-panel');
        const ov = document.getElementById('overlay');
        const show = el.style.display === 'block';
        el.style.display = show ? 'none' : 'block';
        ov.style.display = show ? 'none' : 'block';
    },
    updateHUD: () => {
        document.getElementById('qaCount').innerText = "NATIVO + " + QA_MEMORY.length;
        document.getElementById('docCount').innerText = DOC_MEMORY.length;
    }
};

const Graphics = {
    cvs: document.getElementById('arcCanvas'), ctx: document.getElementById('arcCanvas').getContext('2d'),
    angle: 0, speed: 0.02, isSpeaking: false,
    start: () => Graphics.loop(),
    loop: () => {
        const ctx = Graphics.ctx; const w=300, h=300, cx=w/2, cy=h/2;
        ctx.clearRect(0,0,w,h); Graphics.angle+=Graphics.speed;
        
        // Arc externo
        ctx.strokeStyle = "#00f3ff"; ctx.lineWidth=5; ctx.beginPath();
        ctx.arc(cx, cy, 80, Graphics.angle, Graphics.angle+2); ctx.stroke();
        ctx.beginPath(); ctx.arc(cx, cy, 80, Graphics.angle+Math.PI, Graphics.angle+Math.PI+2); ctx.stroke();
        
        // Arc interno reverso
        ctx.strokeStyle = "rgba(0, 243, 255, 0.4)"; ctx.lineWidth=2; ctx.beginPath();
        ctx.arc(cx, cy, 60, -Graphics.angle*1.5, -Graphics.angle*1.5+4); ctx.stroke();
        
        // N√∫cleo
        const core = Graphics.isSpeaking ? 30+(Math.random()*15) : 30+(Math.sin(Date.now()/500)*2);
        
        // Glow effect
        ctx.shadowBlur = 20; ctx.shadowColor = "#00f3ff";
        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(cx, cy, 5, 0, Math.PI*2); ctx.fill();
        
        ctx.strokeStyle="#fff"; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(cx,cy, core, 0, Math.PI*2); ctx.stroke();
        ctx.shadowBlur = 0; 

        requestAnimationFrame(Graphics.loop);
    }
};

window.onload = Jarvis.init;
</script>
</body>
</html>

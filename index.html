<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S. v7.0 - INTEGRATED SYSTEMS</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';</script>

    <style>
        :root { --bg: #050505; --cyan: #00f3ff; --glass: rgba(0, 243, 255, 0.05); --font: 'Segoe UI', 'Consolas', sans-serif; }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: var(--cyan); font-family: var(--font); height: 100vh; display: flex; flex-direction: column; overflow: hidden; text-shadow: 0 0 5px var(--cyan); }
        
        #main-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; z-index: 1; width: 100%; }
        
        /* REACTOR VISUAL (CORRIGIDO) */
        #reactor-container { 
            width: 280px; 
            height: 280px; 
            position: relative; 
            margin-bottom: 20px; 
            border-radius: 50%;
        }
        
        canvas { display: block; width: 100%; height: 100%; }
        
        .circle-glow { 
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; border-radius: 50%; 
            box-shadow: 0 0 40px rgba(0, 243, 255, 0.15), inset 0 0 20px rgba(0, 243, 255, 0.1); 
            animation: pulse 4s infinite; pointer-events: none;
        }

        /* CHAT */
        #chat-panel { width: 90%; max-width: 700px; height: 30vh; background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,20,30,0.9) 100%); border: 1px solid #333; border-left: 2px solid var(--cyan); padding: 15px; overflow-y: auto; margin-bottom: 20px; font-size: 14px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 8px 12px; border-radius: 4px; animation: fadeIn 0.3s; max-width: 90%; line-height: 1.4; }
        .msg.user { text-align: right; color: #fff; border-right: 2px solid #555; align-self: flex-end; }
        .msg.ai { text-align: left; color: var(--cyan); border-left: 2px solid var(--cyan); align-self: flex-start; background: var(--glass); }
        .msg.sys { font-size: 11px; color: #aaa; align-self: center; border: 1px dashed #333; }
        
        /* INPUTS */
        #input-dock { width: 90%; max-width: 700px; display: flex; gap: 10px; background: #080808; padding: 12px; border: 1px solid #333; border-radius: 40px; box-shadow: 0 0 30px rgba(0,0,0,0.5); margin-bottom: 20px; position:relative; z-index: 10; }
        input[type="text"] { flex: 1; background: transparent; border: none; color: #fff; font-family: inherit; padding: 0 15px; outline: none; font-size: 16px; }
        button { background: transparent; border: 1px solid var(--cyan); color: var(--cyan); border-radius: 50%; width: 45px; height: 45px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; font-size:16px; flex-shrink: 0; }
        button:hover { background: var(--glass); box-shadow: 0 0 15px var(--cyan); }
        button.active { background: var(--cyan); color: #000; box-shadow: 0 0 25px var(--cyan); }
        
        /* PAINEL DE DADOS */
        #ingest-panel { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 500px; background: #0f0f12; border: 1px solid var(--cyan); padding: 25px; z-index: 100; display: none; box-shadow: 0 0 100px rgba(0,0,0,0.9); border-radius: 8px; }
        #ingest-panel h3 { margin-top:0; color: var(--cyan); border-bottom: 1px solid #333; padding-bottom: 10px; font-size: 14px; letter-spacing: 2px; }
        .ingest-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .ingest-input { flex: 1; background: #000; border: 1px solid #444; color: #fff; padding: 10px; font-family: monospace; border-radius: 4px; }
        .btn-rect { border-radius: 4px; width: auto; padding: 0 20px; font-size: 11px; font-weight: bold; border: 1px solid #444; color: #888; text-transform: uppercase; cursor: pointer; }
        .btn-rect:hover { border-color: var(--cyan); color: var(--cyan); background: rgba(0,243,255,0.1); }
        .close-btn { position: absolute; top: 10px; right: 10px; border: none; font-size: 20px; color: #555; width: 30px; height: 30px; cursor:pointer; }
        
        #overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index: 90; display:none; backdrop-filter: blur(2px); }

        .hud-corner { position: absolute; padding: 20px; font-size: 10px; color: #555; pointer-events: none; font-family: monospace; }
        .top-left { top: 0; left: 0; text-align: left; border-top: 1px solid #333; border-left: 1px solid #333; width: 120px; height: 100px; }
        
        @keyframes pulse { 0% { opacity: 0.6; box-shadow: 0 0 20px rgba(0, 243, 255, 0.1); } 50% { opacity: 1; box-shadow: 0 0 50px rgba(0, 243, 255, 0.3); } 100% { opacity: 0.6; box-shadow: 0 0 20px rgba(0, 243, 255, 0.1); } }
        @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 5px; } ::-webkit-scrollbar-thumb { background: #333; }
    </style>
</head>
<body>

    <div id="overlay"></div>

    <div id="ingest-panel">
        <button class="close-btn" onclick="UI.toggleIngest()">Ã—</button>
        <h3>MÃ“DULO DE APRENDIZADO</h3>
        
        <p style="font-size:11px; color:#888; margin-bottom:5px;">FONTE WEB (URL)</p>
        <div class="ingest-row">
            <input type="text" id="urlInput" class="ingest-input" placeholder="https://exemplo.com/artigo">
            <button class="btn-rect" onclick="Jarvis.ingestURL()">LER</button>
        </div>

        <p style="font-size:11px; color:#888; margin-bottom:5px;">ARQUIVO LOCAL (PDF)</p>
        <div class="ingest-row">
            <input type="file" id="pdfInput" class="ingest-input" accept="application/pdf">
            <button class="btn-rect" onclick="Jarvis.ingestPDF()">LER</button>
        </div>
        
        <div style="text-align:center; margin-top:20px; border-top:1px solid #222; padding-top:15px;">
            <button class="btn-rect" onclick="Jarvis.downloadMemory()" style="border-color:#00ff66; color:#00ff66; width:100%;">BAIXAR MEMÃ“RIA (JSON)</button>
        </div>
    </div>

    <div class="hud-corner top-left">
        SYSTEM: ONLINE<br>
        NODES: <span id="qaCount">0</span><br>
        DOCS: <span id="docCount" style="color:var(--cyan)">0</span>
    </div>
    
    <div id="main-container">
        <div id="reactor-container">
            <div class="circle-glow"></div>
            <canvas id="arcCanvas"></canvas>
        </div>

        <div id="chat-panel">
            <div class="msg ai"><span class="sender">J.A.R.V.I.S.</span>Interface visual calibrada. MÃ³dulo de pesquisa Jina AI ativo.</div>
        </div>

        <div id="input-dock">
            <button id="btnIngest" title="Adicionar Dados">+</button>
            <input type="text" id="txtInput" placeholder="Digite ou use o microfone..." autocomplete="off">
            <button id="btnSend" title="Enviar">âž¤</button>
            <button id="btnMic" title="Voz">ðŸŽ¤</button>
        </div>
    </div>

<script>
// MEMÃ“RIA VOLÃTIL
let QA_MEMORY = [];
let DOC_MEMORY = [];

const Jarvis = {
    listening: false,
    synth: window.speechSynthesis,
    recognition: null,

    init: async () => {
        // Tenta carregar memÃ³ria salva no repositÃ³rio, se existir
        try {
            const res = await fetch('database.json');
            if(res.ok) QA_MEMORY = await res.json();
            UI.updateHUD();
        } catch(e) { console.log("Database offline (usando modo limpo)."); }

        // ConfiguraÃ§Ã£o de Voz
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(Speech) {
            Jarvis.recognition = new Speech();
            Jarvis.recognition.lang = 'pt-BR';
            Jarvis.recognition.continuous = false;
            Jarvis.recognition.onresult = (e) => Jarvis.processInput(e.results[0][0].transcript);
            Jarvis.recognition.onend = () => Jarvis.toggleMic(false);
        }

        // Event Listeners
        document.getElementById('btnMic').onclick = () => Jarvis.toggleMic();
        document.getElementById('btnSend').onclick = () => Jarvis.handleText();
        document.getElementById('btnIngest').onclick = () => UI.toggleIngest();
        document.getElementById('txtInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') Jarvis.handleText(); });
        
        // Inicia GrÃ¡ficos
        Graphics.init();
    },

    // --- LEITOR DE URL (WEB SCRAPER COM JINA AI) ---
    ingestURL: async () => {
        const url = document.getElementById('urlInput').value;
        if(!url) return;
        
        if(!url.startsWith('http')) { UI.addMsg('sys', 'Erro: Use http:// ou https://'); return; }

        UI.addMsg('sys', `Conectando via Jina Reader: ${url}...`);
        UI.toggleIngest(); 

        try {
            const target = `https://r.jina.ai/${url}`;
            const response = await fetch(target, { method: 'GET', headers: { 'Cache-Control': 'no-cache' } });
            
            if (!response.ok) throw new Error("Bloqueio de servidor");

            let text = await response.text();
            
            // Limpeza de Markdown bÃ¡sico para poupar tokens
            text = text.replace(/!\[.*?\]\(.*?\)/g, '') // Tira imagens
                       .replace(/\[.*?\]\(.*?\)/g, '$1'); // Tira links mantendo texto

            if(text.length < 50 || text.includes("Access denied")) throw new Error("ConteÃºdo protegido ou vazio.");

            // Limite de seguranÃ§a
            const cleanText = text.substring(0, 20000); 

            DOC_MEMORY.push({ source: "WEB: " + url, content: cleanText });
            
            UI.addMsg('ai', `Dados assimilados. Li ${cleanText.length} caracteres de conteÃºdo puro.`);
            UI.updateHUD();

        } catch(err) {
            UI.addMsg('sys', `FALHA: O site bloqueou a leitura. Tente outra fonte.`);
            console.error(err);
        }
    },

    // --- LEITOR DE PDF (LOCAL) ---
    ingestPDF: async () => {
        const file = document.getElementById('pdfInput').files[0];
        if(!file) return;
        UI.addMsg('sys', "Processando PDF...");
        UI.toggleIngest();
        
        const fileReader = new FileReader();
        fileReader.onload = async function() {
            try {
                const typedarray = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                let fullText = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(item => item.str).join(' ') + "\n";
                }
                DOC_MEMORY.push({ source: "PDF: " + file.name, content: fullText });
                UI.addMsg('ai', `PDF lido: "${file.name}".`);
                UI.updateHUD();
            } catch(err) { UI.addMsg('sys', "Erro ao ler PDF."); }
        };
        fileReader.readAsArrayBuffer(file);
    },

    // --- PROCESSAMENTO DE RESPOSTA ---
    processInput: (text) => {
        UI.addMsg('user', text);
        let response = null;
        const lower = text.toLowerCase();

        // 1. Hardcoded
        if(lower.includes("obrigado")) response = "Ã€s ordens.";
        
        // 2. Database JSON (Perguntas exatas)
        if(!response) {
            const hit = QA_MEMORY.find(entry => entry.triggers.some(t => lower.includes(t.toLowerCase())));
            if(hit) response = hit.response;
        }

        // 3. Pesquisa em Documentos (PDF/URL)
        if(!response && DOC_MEMORY.length > 0) {
            const keywords = lower.split(' ').filter(w => w.length > 3); // Ignora palavras curtas
            let bestMatch = { score: 0, text: "" };

            DOC_MEMORY.forEach(doc => {
                let score = 0;
                keywords.forEach(k => {
                    if(doc.content.toLowerCase().includes(k)) score++;
                });
                
                if(score > bestMatch.score) {
                    const idx = doc.content.toLowerCase().indexOf(keywords[0]);
                    const start = Math.max(0, idx - 50);
                    // Pega um trecho de 350 caracteres
                    bestMatch = { score, text: doc.content.substring(start, start + 350), source: doc.source };
                }
            });

            if(bestMatch.score > 0) {
                response = `Encontrei nos dados (${bestMatch.source}): "...${bestMatch.text}..."`;
            }
        }

        if(!response) response = "NÃ£o encontrei essa informaÃ§Ã£o nos meus dados locais.";

        setTimeout(() => Jarvis.respond(response), 500);
    },

    respond: (text) => {
        UI.addMsg('ai', text);
        if(Jarvis.synth.speaking) Jarvis.synth.cancel();
        const utter = new SpeechSynthesisUtterance(text);
        const voices = Jarvis.synth.getVoices();
        const pt = voices.find(v => v.lang.includes('pt-BR'));
        if(pt) utter.voice = pt;
        utter.rate = 1.2; 
        utter.onstart = () => Graphics.isSpeaking = true;
        utter.onend = () => Graphics.isSpeaking = false;
        Jarvis.synth.speak(utter);
    },

    toggleMic: (force) => {
        if(!Jarvis.recognition) return;
        Jarvis.listening = force !== undefined ? force : !Jarvis.listening;
        const btn = document.getElementById('btnMic');
        if(Jarvis.listening) { Jarvis.recognition.start(); btn.classList.add('active'); Graphics.targetSpeed = 0.2; }
        else { try{Jarvis.recognition.stop();}catch(e){} btn.classList.remove('active'); Graphics.targetSpeed = 0.02; }
    },
    
    handleText: () => {
        const i = document.getElementById('txtInput');
        if(i.value.trim()) { Jarvis.processInput(i.value.trim()); i.value=""; }
    },

    downloadMemory: () => {
        const blob = new Blob([JSON.stringify(QA_MEMORY, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `database.json`;
        a.click();
    }
};

const UI = {
    addMsg: (type, text) => {
        const p = document.getElementById('chat-panel');
        const d = document.createElement('div'); d.className = `msg ${type}`;
        if(type==='ai' || type==='user') d.innerHTML = `<span class="sender">${type.toUpperCase()}</span>${text}`;
        else d.innerText = text;
        p.appendChild(d); p.scrollTop = p.scrollHeight;
    },
    toggleIngest: () => {
        const el = document.getElementById('ingest-panel');
        const ov = document.getElementById('overlay');
        const show = el.style.display === 'block';
        el.style.display = show ? 'none' : 'block';
        ov.style.display = show ? 'none' : 'block';
    },
    updateHUD: () => {
        document.getElementById('qaCount').innerText = QA_MEMORY.length;
        document.getElementById('docCount').innerText = DOC_MEMORY.length;
    }
};

// --- GRÃFICOS E ANIMAÃ‡ÃƒO ---
const Graphics = {
    cvs: document.getElementById('arcCanvas'),
    ctx: document.getElementById('arcCanvas').getContext('2d'),
    angle: 0, currentSpeed: 0.02, targetSpeed: 0.02, isSpeaking: false,
    width: 0, height: 0,

    init: () => {
        window.addEventListener('resize', Graphics.resize);
        Graphics.resize();
        Graphics.loop();
    },

    resize: () => {
        const container = document.getElementById('reactor-container');
        const dpr = window.devicePixelRatio || 1;
        Graphics.cvs.width = container.clientWidth * dpr;
        Graphics.cvs.height = container.clientHeight * dpr;
        Graphics.ctx.scale(dpr, dpr);
        Graphics.width = container.clientWidth;
        Graphics.height = container.clientHeight;
    },

    loop: () => {
        const ctx = Graphics.ctx;
        const w = Graphics.width; const h = Graphics.height;
        const cx = w/2; const cy = h/2;
        
        Graphics.currentSpeed += (Graphics.targetSpeed - Graphics.currentSpeed) * 0.1;
        Graphics.angle += Graphics.currentSpeed;

        ctx.clearRect(0, 0, w, h);

        const radius = Math.min(w, h) * 0.35; 

        // Anel Externo
        ctx.strokeStyle = "#00f3ff"; ctx.lineWidth = 4; ctx.beginPath();
        ctx.arc(cx, cy, radius, Graphics.angle, Graphics.angle + 2); ctx.stroke();
        ctx.beginPath(); ctx.arc(cx, cy, radius, Graphics.angle + Math.PI, Graphics.angle + Math.PI + 2); ctx.stroke();

        // Anel Interno
        ctx.strokeStyle = "rgba(0, 243, 255, 0.4)"; ctx.lineWidth = 2; ctx.beginPath();
        ctx.arc(cx, cy, radius * 0.8, -Graphics.angle*1.5, -Graphics.angle*1.5 + 4); ctx.stroke();

        // NÃºcleo
        const coreVar = Graphics.isSpeaking ? Math.random() * 5 : 0;
        ctx.fillStyle = "#00f3ff"; ctx.beginPath(); ctx.arc(cx, cy, 4, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = "#fff"; ctx.lineWidth = 1.5; ctx.beginPath(); ctx.arc(cx, cy, (radius*0.15) + coreVar, 0, Math.PI*2); ctx.stroke();

        requestAnimationFrame(Graphics.loop);
    }
};

window.onload = Jarvis.init;
</script>
</body>
</html>

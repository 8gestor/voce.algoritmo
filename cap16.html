<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCS: SINGULARITY ENGINE v5.8 - ARCHITECT</title>
    <style>
        :root {
            --bg: #000000;
            --panel: #0a0a0c;
            --border: #222;
            --cyan: #00f3ff;
            --purple: #bc13fe;
            --amber: #ffaa00;
            --green: #00ff66;
            --rec: #ff0044;
            --data: #0088ff;
            --font: 'Consolas', 'Monaco', monospace;
        }

        * { box-sizing: border-box; user-select: none; }
        body { margin: 0; padding: 0; background-color: var(--bg); color: #ccc; font-family: var(--font); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        header { border-bottom: 1px solid var(--cyan); padding: 0 20px; display: flex; justify-content: space-between; align-items: center; background: var(--panel); height: 40px; flex-shrink: 0; z-index: 100; box-shadow: 0 0 20px rgba(0, 243, 255, 0.2); }
        h1 { margin: 0; font-size: 13px; letter-spacing: 3px; color: var(--cyan); text-shadow: 0 0 10px var(--cyan); }
        .status-led { width: 8px; height: 8px; border-radius: 50%; background: #333; transition: 0.3s; }
        .status-led.on { background: var(--green); box-shadow: 0 0 10px var(--green); }

        main { display: flex; flex: 1; overflow: hidden; }
        aside { width: 340px; background: var(--panel); border-right: 1px solid var(--border); padding: 10px; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; flex-shrink: 0; }

        .module { border: 1px solid #2a2a2a; padding: 10px; position: relative; margin-top: 5px; background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, rgba(0,0,0,0) 100%); border-radius: 4px; }
        .mod-label { position: absolute; top: -7px; left: 8px; background: var(--panel); padding: 0 5px; font-size: 8px; color: var(--cyan); text-transform: uppercase; border: 1px solid #222; }

        .row { display: flex; gap: 5px; margin-bottom: 6px; }
        button { flex: 1; background: #080808; color: #888; border: 1px solid #444; padding: 8px; font-size: 10px; font-weight: bold; text-transform: uppercase; cursor: pointer; transition: 0.2s; border-radius: 2px; }
        button:hover:not(:disabled) { border-color: var(--cyan); color: var(--cyan); background: rgba(0,243,255,0.1); }
        button.active { border-color: var(--cyan); color: #000; background: var(--cyan); box-shadow: 0 0 10px var(--cyan); }
        button.recording { border-color: var(--rec); color: var(--rec); animation: blink 1s infinite; }
        
        input[type="text"] { width: 100%; background: #000; border: 1px solid #444; color: var(--green); font-family: inherit; font-size: 10px; padding: 8px; margin-bottom: 5px; outline: none; }
        
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* Spectral Monitor */
        .spec-row { display: flex; align-items: center; gap: 10px; font-size: 9px; margin-bottom: 4px; }
        .spec-name { width: 40px; text-align: right; color: #777; }
        .bar-container { flex: 1; height: 4px; background: #111; border: 1px solid #333; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.1s; }
        .bar-infra { background: var(--purple); } 
        .bar-audio { background: var(--cyan); } 
        .bar-ultra { background: #ff0055; }

        /* VIEWPORT & DASHBOARD */
        #viewport { flex: 1.8; position: relative; background: #000; overflow: hidden; border-bottom: 1px solid #1a1a1a; }
        canvas { width: 100%; height: 100%; display: block; }

        #dashboard { height: 145px; background: #050508; display: flex; border-top: 1px solid var(--cyan); flex-shrink: 0; }
        .dash-panel { flex: 1; display: flex; flex-direction: column; position: relative; border-right: 1px solid #1a1a1a; }
        .dash-label { background: #0d0d0f; color: var(--cyan); font-size: 9px; padding: 3px 12px; letter-spacing: 1.5px; border-bottom: 1px solid #1a1a1a; font-weight: bold; }
        #log-stream { flex: 1; overflow-y: auto; padding: 8px; font-size: 9px; color: #555; }
        .log-entry { display: grid; grid-template-columns: 60px 80px 70px 1fr; border-bottom: 1px solid #111; padding: 2px 0; }
        #infra-dash { flex: 1.3; position: relative; background: #010102; overflow: hidden; }

        .hud { position: absolute; pointer-events: none; padding: 20px; z-index: 10; }
        .val-big { font-size: 38px; font-weight: bold; color: var(--cyan); text-shadow: 0 0 15px var(--cyan); }
        .modem-hud { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); color: var(--amber); font-size: 14px; background: rgba(0,0,0,0.8); padding: 10px; border: 1px solid var(--amber); display: none; z-index: 20; text-align: center; font-weight: bold; }

    </style>
</head>
<body>

<header>
    <h1>SCS: SINGULARITY ENGINE v5.8 - ARCHITECT</h1>
    <div style="display:flex; align-items:center; gap:10px;">
        <span id="headerStatus" style="font-size:10px; color:#444;">SYS_STANDBY</span>
        <div id="sysLed" class="status-led"></div>
    </div>
</header>

<main>
    <aside>
        <div class="module">
            <span class="mod-label">00. Hardware Ignition</span>
            <div class="row">
                <button id="btnInit" onclick="SCS.init()" style="color:var(--green); border-color:var(--green);">INICIALIZAR</button>
                <button onclick="location.reload()" style="color:var(--amber); border-color:var(--amber);">REINICIAR</button>
            </div>
        </div>

        <div class="module">
            <span class="mod-label">01. Signal Source Admin</span>
            <div class="row">
                <button id="btnMic" onclick="SCS.useMic()" disabled>üé§ MICROFONE</button>
                <button id="btnFile" onclick="document.getElementById('fAudio').click()" disabled>üìÇ ARQUIVO</button>
                <input type="file" id="fAudio" hidden onchange="SCS.useFile(this)">
            </div>
            <div class="row">
                <button id="btnPlay" onclick="SCS.mediaControl('play')" disabled>‚ñ∂ PLAY</button>
                <button id="btnPause" onclick="SCS.mediaControl('pause')" disabled>II PAUSE</button>
                <button id="btnStop" onclick="SCS.mediaControl('stop')" disabled>‚ñ† STOP</button>
            </div>
        </div>

        <div class="module">
            <span class="mod-label">02. Logging & Data Gen</span>
            <div class="row">
                <button id="btnRec" onclick="SCS.toggleRecording()" disabled>‚óè GRAVAR LOG</button>
                <button id="btnExport" onclick="SCS.exportLog()" disabled>üíæ EXPORTAR JSON</button>
            </div>
        </div>

        <div class="module">
            <span class="mod-label">03. Secure Data-Link</span>
            <input type="text" id="cryptoKey" placeholder="CHAVE DE CRIPTOGRAFIA...">
            <div class="row">
                <button id="btnTx" onclick="SCS.Modem.transmit(true)" disabled style="color:var(--rec)">üì° TX CRYPTO</button>
                <button id="btnRx" onclick="SCS.Modem.receive(true)" disabled style="color:var(--green)">üìü RX CRYPTO</button>
            </div>
            <div class="row">
                <button id="btnTxSimple" onclick="SCS.Modem.transmit(false)" disabled style="color:var(--amber); font-size: 8px;">üì° TX SIMPLE</button>
                <button id="btnRxSimple" onclick="SCS.Modem.receive(false)" disabled style="color:var(--data); font-size: 8px;">üìü RX SIMPLE</button>
            </div>
        </div>

        <div class="module">
            <span class="mod-label">04. Archive & Simulation</span>
            <div class="row">
                <button id="btnImport" onclick="document.getElementById('fLog').click()" disabled>üìÇ CARREGAR LOG</button>
                <input type="file" id="fLog" hidden accept=".json" onchange="SCS.importLog(this)">
                <button id="btnSim" onclick="SCS.startSimulation()" disabled style="color:var(--green)">‚ñ∂ RODAR SIMULA√á√ÉO</button>
            </div>
        </div>

        <div class="module">
            <span class="mod-label">05. Spectral Monitor</span>
            <div class="spec-row">
                <span class="spec-name">INFRA</span>
                <div class="bar-container"><div id="barInfra" class="bar-fill bar-infra"></div></div>
            </div>
            <div class="spec-row">
                <span class="spec-name">AUDIO</span>
                <div class="bar-container"><div id="barAudio" class="bar-fill bar-audio"></div></div>
            </div>
            <div class="spec-row">
                <span class="spec-name">ULTRA</span>
                <div class="bar-container"><div id="barUltra" class="bar-fill bar-ultra"></div></div>
            </div>
        </div>

        <div class="module">
            <span class="mod-label">06. Visual Matrix Layers</span>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <button id="btnLayOrb" class="active" onclick="SCS.toggleLayer('ORB')">C√öPULA</button>
                <button id="btnLayRays" class="active" onclick="SCS.toggleLayer('RAYS')">ROTAS</button>
                <button id="btnLayDrone" class="active" onclick="SCS.toggleLayer('DRONES')">DRONES</button>
                <button id="btnLayHarm" class="active" onclick="SCS.toggleLayer('HARMONICS')">FRACTAL</button>
            </div>
        </div>
    </aside>

    <div style="display:flex; flex-direction:column; flex:1;">
        <div id="viewport">
            <canvas id="scope"></canvas>
            <div class="hud">
                <div style="font-size:11px; color:var(--cyan); letter-spacing:2px; font-weight:bold;">PEAK RESONANCE</div>
                <div class="val-big" id="hudFreq">0.0</div>
                <div id="hudTime" style="color:#444; font-size:10px; margin-top:2px;">T+ 00:00:00</div>
            </div>
            <div id="modemHud" class="modem-hud">SECURE_LINK_IDLE</div>
        </div>

        <div id="dashboard">
            <div class="dash-panel">
                <div class="dash-label">MATHEMATICAL TELEMETRY STREAM</div>
                <div id="log-stream">
                    <div style="padding:15px; text-align:center; color:#222; font-size:10px;">AWAITING DATA...</div>
                </div>
            </div>

            <div class="dash-panel" style="border-right:none;">
                <div class="dash-label">INFRASONIC OSCILLOSCOPE (0-20Hz)</div>
                <div id="infra-dash">
                    <canvas id="infraCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>
</main>

<audio id="audioEl" hidden crossorigin="anonymous"></audio>

<script>
const SCS = {
    // Hardware & Core
    ac: null, an: null, src: null,
    cvs: document.getElementById('scope'),
    ctx: document.getElementById('scope').getContext('2d'),
    infCvs: document.getElementById('infraCanvas'),
    infCtx: document.getElementById('infraCanvas').getContext('2d'),
    elAudio: document.getElementById('audioEl'),
    
    config: { fft: 4096, orbRadius: 0, fov: 650, maxMainDrones: 8, harmonicsPerPoint: 4, subHarmonics: 3, baseFontSize: 14, droneSize: 7, lineWidth: 2.2 },
    active: false, state: 'IDLE', layers: { ORB: true, RAYS: true, DRONES: true, HARMONICS: true },
    angle: 0, peaks: [], isRecording: false, logBuffer: [], simData: null, simStartTime: 0, sysStartTime: Date.now(),
    infraHistory: new Array(300).fill(0),

    modem: { active: false, mode: null, buffer: [], idx: 0, baseFreq: 4000, stepFreq: 250, speed: 80, isEncrypted: false, key: "" },

    init: async function() {
        try {
            const AC = window.AudioContext || window.webkitAudioContext;
            this.ac = new AC({ sampleRate: 48000 });
            this.an = this.ac.createAnalyser(); this.an.fftSize = this.config.fft;
            this.resize(); window.onresize = () => this.resize();
            this.active = true;
            document.getElementById('btnInit').disabled = true;
            ['btnMic','btnFile','btnStop','btnRec','btnImport','btnTx','btnRx','btnTxSimple','btnRxSimple'].forEach(id => document.getElementById(id).disabled = false);
            document.getElementById('sysLed').classList.add('on');
            document.getElementById('headerStatus').innerText = "LIVE_ON";
            this.sysStartTime = Date.now();
            this.loop();
        } catch(e) { console.error("INIT_ERR", e); }
    },

    resize: function() {
        const dpr = window.devicePixelRatio || 1;
        const rect = this.cvs.parentElement.getBoundingClientRect();
        this.cvs.width = rect.width * dpr; this.cvs.height = rect.height * dpr;
        this.ctx.scale(dpr, dpr); this.width = rect.width; this.height = rect.height;
        const infRect = document.getElementById('infra-dash').getBoundingClientRect();
        this.infCvs.width = infRect.width; this.infCvs.height = infRect.height;
        this.config.orbRadius = Math.min(this.width, this.height) * 0.49;
    },

    mediaControl: function(action) {
        if(action === 'play') this.elAudio.play();
        if(action === 'pause') this.elAudio.pause();
        if(action === 'stop') { this.elAudio.pause(); this.elAudio.currentTime = 0; }
    },

    useMic: async function() {
        const s = await navigator.mediaDevices.getUserMedia({ audio: true });
        this.connect(this.ac.createMediaStreamSource(s), "MIC");
    },
    useFile: function(el) {
        if(!el.files[0]) return;
        this.elAudio.src = URL.createObjectURL(el.files[0]);
        this.connect(this.ac.createMediaElementSource(this.elAudio), "FILE");
        ['btnPlay','btnPause'].forEach(id => document.getElementById(id).disabled = false);
    },
    connect: function(src, type) {
        if(this.src) this.src.disconnect();
        this.src = src; this.src.connect(this.an);
        if(type === 'FILE') this.src.connect(this.ac.destination);
        this.state = 'LIVE';
    },

    // --- DATA-LINK MODULE ---
    Modem: {
        scramble: function(data, key) {
            if(!key) return data;
            let seed = key.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
            let scrambled = data.split('');
            for (let i = scrambled.length - 1; i > 0; i--) {
                const j = (seed * (i + 1)) % scrambled.length;
                [scrambled[i], scrambled[j]] = [scrambled[j], scrambled[i]];
            }
            return scrambled.join('');
        },
        transmit: function(encrypted) {
            if(SCS.logBuffer.length === 0) return;
            SCS.modem.active = true; SCS.modem.mode = 'TX'; SCS.modem.isEncrypted = encrypted;
            SCS.modem.key = document.getElementById('cryptoKey').value;
            document.getElementById('modemHud').style.display = 'block';
            let dataStr = "";
            for(let i=0; i<Math.min(SCS.logBuffer.length, 64); i++) {
                dataStr += Math.floor(SCS.logBuffer[i].peaks[0].f).toString(16).padStart(4, '0');
            }
            if(encrypted && SCS.modem.key) { dataStr = this.scramble(dataStr, SCS.modem.key); SCS.modem.speed = 40; SCS.modem.baseFreq = 6000; } 
            else { SCS.modem.speed = 80; SCS.modem.baseFreq = 4000; }
            SCS.modem.buffer = "AAAA" + dataStr + "FFFF"; SCS.modem.idx = 0;
            this.txLoop();
        },
        txLoop: function() {
            if(!SCS.modem.active || SCS.modem.idx >= SCS.modem.buffer.length) { this.stop(); return; }
            const val = parseInt(SCS.modem.buffer[SCS.modem.idx], 16);
            const freq = SCS.modem.baseFreq + (val * SCS.modem.stepFreq);
            const osc = SCS.ac.createOscillator(); const g = SCS.ac.createGain();
            osc.frequency.value = freq; osc.connect(g); g.connect(SCS.ac.destination);
            const now = SCS.ac.currentTime;
            g.gain.setValueAtTime(0.5, now); g.gain.exponentialRampToValueAtTime(0.01, now + (SCS.modem.speed/1000));
            osc.start(); osc.stop(now + (SCS.modem.speed/1000));
            document.getElementById('modemHud').innerText = `TX: ${SCS.modem.buffer[SCS.modem.idx]}`;
            SCS.modem.idx++; setTimeout(() => this.txLoop(), SCS.modem.speed);
        },
        receive: function(enc) { SCS.useMic(); SCS.modem.active = true; SCS.modem.mode = 'RX'; document.getElementById('modemHud').style.display = 'block'; document.getElementById('modemHud').innerText = "RX_SCAN..."; },
        stop: function() { SCS.modem.active = false; document.getElementById('modemHud').style.display = 'none'; }
    },

    // --- TELEMETRY ---
    toggleRecording: function() {
        this.isRecording = !this.isRecording;
        document.getElementById('btnRec').classList.toggle('recording');
        if(!this.isRecording) document.getElementById('btnExport').disabled = false;
    },
    exportLog: function() {
        const blob = new Blob([JSON.stringify({ frames: this.logBuffer })], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `SCS_LOG_${Date.now()}.json`; a.click();
    },
    importLog: function(input) {
        const reader = new FileReader();
        reader.onload = (e) => { this.simData = JSON.parse(e.target.result); document.getElementById('btnSim').disabled = false; };
        reader.readAsText(input.files[0]);
    },
    startSimulation: function() { if (this.simData) { this.state = 'SIM'; this.simStartTime = Date.now(); } },

    // --- RENDER CORE ---
    loop: function() {
        requestAnimationFrame(() => this.loop());
        if(!this.active) return;
        this.ctx.globalCompositeOperation = 'source-over';
        this.ctx.fillStyle = "#000000"; this.ctx.fillRect(0, 0, this.width, this.height);
        this.angle += 0.007;
        const diff = new Date(Date.now() - this.sysStartTime);
        document.getElementById('hudTime').innerText = "T+ " + diff.toISOString().substr(11, 8);

        if (this.state === 'LIVE') {
            const data = new Uint8Array(this.an.frequencyBinCount);
            this.an.getByteFrequencyData(data);
            this.analyze(data); this.processInfra(data);
            this.updateSpectralMonitor(data); this.updateDashboardLog(); 
            if (this.isRecording) this.logBuffer.push({ time: Date.now(), peaks: JSON.parse(JSON.stringify(this.peaks)) });
        } else if (this.state === 'SIM') { this.handleSimulation(); this.updateDashboardLog(); }
        this.drawGalaxy(); this.drawInfraDashboard();
    },

    updateSpectralMonitor: function(data) {
        let iSum=0, aSum=0, uSum=0; let iC=0, aC=0, uC=0;
        for(let i=0; i<data.length; i++) {
            const hz = i * (this.ac.sampleRate / this.config.fft);
            if(hz < 20) { iSum+=data[i]; iC++; } else if(hz > 15000) { uSum+=data[i]; uC++; } else { aSum+=data[i]; aC++; }
        }
        document.getElementById('barInfra').style.width = Math.min(100, (iSum/iC||1)*2) + "%";
        document.getElementById('barAudio').style.width = Math.min(100, (aSum/aC||1)*2) + "%";
        document.getElementById('barUltra').style.width = Math.min(100, (uSum/uC||1)*2) + "%";
    },

    analyze: function(data) {
        let p = [];
        for(let i=2; i<data.length-2; i++) {
            if(data[i] > 110 && data[i] > data[i-1] && data[i] > data[i+1]) {
                p.push({ f: i * (this.ac.sampleRate / this.config.fft), v: data[i] });
            }
        }
        this.peaks = p.sort((a,b) => b.v - a.v).slice(0, this.config.maxMainDrones);
        if(this.peaks[0]) document.getElementById('hudFreq').innerText = this.peaks[0].f.toFixed(1);
    },

    processInfra: function(data) {
        let sum = (data[0] + data[1] + data[2]) / 3;
        this.infraHistory.push(sum); this.infraHistory.shift();
    },

    updateDashboardLog: function() {
        if (this.peaks.length === 0) return;
        const stream = document.getElementById('log-stream');
        if (stream.innerHTML.includes('AWAITING')) stream.innerHTML = '';
        const row = document.createElement('div'); row.className = 'log-entry';
        const p = this.peaks[0]; const t = new Date().toLocaleTimeString('pt-BR', { hour12: false });
        row.innerHTML = `<div>[${t}]</div><div>${p.f.toFixed(1)}Hz</div><div>AMP_${p.v}</div><div>SYNC</div>`;
        stream.prepend(row); if(stream.childElementCount > 30) stream.removeChild(stream.lastChild);
    },

    drawInfraDashboard: function() {
        const w = this.infCvs.width, h = this.infCvs.height;
        this.infCtx.fillStyle = "#010102"; this.infCtx.fillRect(0,0,w,h);
        this.infCtx.strokeStyle = "#111"; this.infCtx.lineWidth = 1;
        for(let x=0; x<w; x+=w/10) { this.infCtx.beginPath(); this.infCtx.moveTo(x,0); this.infCtx.lineTo(x,h); this.infCtx.stroke(); }
        this.infCtx.beginPath(); this.infCtx.strokeStyle = "#bc13fe"; this.infCtx.lineWidth = 2;
        for(let i=0; i<this.infraHistory.length; i++) {
            let x = (i / this.infraHistory.length) * w;
            let val = this.infraHistory[i]; let y = h - (val / 255) * h * 0.7 - 15;
            if(i === 0) this.infCtx.moveTo(x,y); else this.infCtx.lineTo(x,y);
        }
        this.infCtx.stroke();
    },

    drawGalaxy: function() {
        const cx = this.width / 2, cy = this.height / 2;
        if(this.layers.ORB) {
            this.ctx.beginPath();
            const g = this.ctx.createRadialGradient(cx, cy, 0, cx, cy, this.config.orbRadius);
            g.addColorStop(0.85, "rgba(0,0,0,0)"); g.addColorStop(0.98, "rgba(0,243,255,0.2)"); g.addColorStop(1, "rgba(255,255,255,0.3)");
            this.ctx.fillStyle = g; this.ctx.arc(cx, cy, this.config.orbRadius, 0, Math.PI*2); this.ctx.fill();
        }
        const scene = [];
        this.peaks.forEach((peak, i) => {
            const t = this.angle + (i * (Math.PI * 2 / this.peaks.length));
            const dist = (peak.v / 255) * this.config.orbRadius * 0.85;
            const main = { x: Math.cos(t) * dist, y: Math.sin(t*0.4)*(dist*0.6), z: Math.sin(t) * dist, f: peak.f, v: peak.v, type: 'MAIN', id: i };
            scene.push(main);
            if(this.layers.HARMONICS) {
                for(let h=1; h<=this.config.harmonicsPerPoint; h++) {
                    const ht = t + (h * 1.2) + this.angle;
                    const L2 = { x: main.x+Math.cos(ht)*65, y: main.y+Math.sin(ht)*65, z: main.z+Math.sin(ht)*65, f: peak.f*(h+1), v: peak.v*0.5, type:'L2', parent: main };
                    scene.push(L2);
                    for(let s=1; s<=this.config.subHarmonics; s++) {
                        const st = ht+(s*0.8)-this.angle;
                        scene.push({ x: L2.x+Math.cos(st)*28, y: L2.y+Math.sin(st)*28, z: L2.z+Math.sin(st)*28, f: L2.f*1.5, v: L2.v*0.4, type:'L3', parent: L2 });
                    }
                }
            }
        });

        if(this.layers.RAYS && scene.filter(s=>s.type==='MAIN').length > 1) {
            const mains = scene.filter(s=>s.type==='MAIN').sort((a,b) => a.id - b.id);
            for(let i=0; i<mains.length-1; i++) {
                const p1 = this.project(mains[i].x, mains[i].y, mains[i].z);
                const p2 = this.project(mains[i+1].x, mains[i+1].y, mains[i+1].z);
                this.ctx.beginPath(); this.ctx.strokeStyle = `hsla(${mains[i].f % 360}, 100%, 60%, 0.5)`;
                this.ctx.lineWidth = this.config.lineWidth * p1.s; this.ctx.moveTo(p1.x, p1.y); this.ctx.lineTo(p2.x, p2.y); this.ctx.stroke();
            }
        }

        scene.sort((a,b) => b.z - a.z).forEach(obj => {
            const proj = this.project(obj.x, obj.y, obj.z);
            this.ctx.globalCompositeOperation = 'lighter';
            if(this.layers.RAYS && obj.parent) {
                const pP = this.project(obj.parent.x, obj.parent.y, obj.parent.z);
                this.ctx.beginPath(); this.ctx.strokeStyle = `hsla(${obj.f % 360}, 100%, 60%, 0.2)`;
                this.ctx.lineWidth = 1 * proj.s; this.ctx.moveTo(pP.x, pP.y); this.ctx.lineTo(proj.x, proj.y); this.ctx.stroke();
            }
            if(this.layers.DRONES) {
                const col = `hsla(${obj.f % 360}, 100%, 60%, ${proj.s})`;
                const size = (obj.type==='MAIN'? this.config.droneSize : obj.type==='L2'? 3.5 : 2) * proj.s;
                this.ctx.fillStyle = col; if(obj.type==='MAIN') { this.ctx.shadowBlur = 15*proj.s; this.ctx.shadowColor = col; }
                this.ctx.beginPath(); this.ctx.arc(proj.x, proj.y, size, 0, Math.PI*2); this.ctx.fill();
                this.ctx.shadowBlur = 0;
                if(obj.z < 100) {
                    const fs = (obj.type==='MAIN'? this.config.baseFontSize : obj.type==='L2'? 10 : 8) * proj.s;
                    this.ctx.fillStyle = "#fff"; this.ctx.font = `${obj.type==='MAIN'?'bold ':''}${fs}px monospace`;
                    this.ctx.fillText(Math.floor(obj.f), proj.x+size+3, proj.y);
                }
            }
        });
    },

    project: function(x, y, z) {
        const s = this.config.fov / (this.config.fov + z);
        return { x: (x * s) + (this.width / 2), y: (y * s) + (this.height / 2), s: s };
    },

    handleSimulation: function() {
        if (!this.simData) return;
        const elapsed = Date.now() - this.simStartTime;
        const frames = this.simData.frames;
        const frame = frames.find(f => (f.time - frames[0].time) >= elapsed);
        if (frame) { this.peaks = frame.peaks; document.getElementById('hudFreq').innerText = this.peaks[0].f.toFixed(1); } else { this.state = 'IDLE'; }
    },

    toggleLayer: function(l) { this.layers[l] = !this.layers[l]; event.target.classList.toggle('active'); }
};
</script>
</body>
</html>
